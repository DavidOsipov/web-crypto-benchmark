# Методология сбора и анализа данных для проекта по бенчмаркингу Web Crypto API

* **Версия документа:** 4.6-ru
* **Дата:** 12.08.2025
* **Аудитория:** Технические специалисты, эксперты в области статистики, веб-производительности и браузерных технологий.

## 1. Введение и цели исследования

Этот документ описывает методологию, используемую для сбора и анализа данных о производительности криптографического хеширования в современных веб-браузерах. После стратегического пересмотра основная цель проекта была переформулирована с приоритетом на **точность измерений, научную строгость и робастность в реальных условиях**, а не на простую репрезентативность.

**Основная цель исследования** — провести высокоточный сравнительный анализ пропускной способности движков Web Crypto, чтобы ответить на следующие вопросы:

1.  **Сравнение производительности браузерных движков:** Существуют ли статистически значимые различия в производительности реализаций `SubtleCrypto.digest()` между основными браузерными движками в оптимизированных условиях?
2.  **Влияние оборудования и среды:** Как характеристики оборудования (архитектура ЦП) и контекст выполнения (мобильное или десктопное устройство) коррелируют со скоростью хеширования?
3.  **Масштабируемость алгоритмов:** Какова точная кривая масштабирования производительности для различных алгоритмов SHA при увеличении размера данных на разных платформах?

Методология разработана с учетом трех ключевых принципов: **максимальная точность**, **статистическая робастность** и **минимизация систематических ошибок (bias)**.

---

## 2. Методология измерений на стороне клиента: робастный подход с приоритетом точности

Для достижения наших исследовательских целей архитектура на стороне клиента была переработана с целью агрессивного устранения источников шума и адаптации к ограничениям различных сред выполнения.

### 2.1. Среда выполнения: изоляция между источниками (Cross-Origin Isolation) — Обязательно

**Решение:** Бенчмарк развертывается исключительно на странице, которая обслуживается с заголовками `Cross-Origin-Opener-Policy: same-origin` и `Cross-Origin-Embedder-Policy: require-corp`. Бенчмарк **ОБЯЗАН** отказаться от запуска, если `window.crossOriginIsolated` имеет значение `false`.

**Обоснование:**
*   **Таймеры высокого разрешения:** Это самое критичное преимущество. Изоляция между источниками (COI) разблокирует таймеры высокой точности (`performance.now()`).
*   **Доступ к SharedArrayBuffer:** COI является обязательным условием для использования `SharedArrayBuffer`.
*   **Стабильность процесса:** COI обеспечивает более строгую изоляцию процессов.

### 2.2. Протокол коммуникации: SharedArrayBuffer с атомарной координацией

**Решение:** Все высокочастотные данные передаются из Web Worker в основной поток через `SharedArrayBuffer` (SAB).

**Обоснование:**
*   **Устранение накладных расходов на сериализацию:** SAB обеспечивает механизм передачи данных без копирования (zero-copy).
*   **Робастная атомарная координация:** Протокол «резервируй и подтверждай» (reserve-and-commit) с использованием атомарных счетчиков (`WR_HEAD`, `COMMITTED`) гарантирует целостность данных. Проверка на переполнение была усилена и теперь использует явную емкость буфера.

### 2.3. Контекст выполнения: Web Worker

**Решение:** Все криптографические операции и измерения выполняются исключительно внутри выделенного Web Worker (`crypto-benchmark.worker.js`).

**Обоснование:**
*   **Отделение от основного потока:** Это предотвращает вмешательство в измерения со стороны рендеринга UI и сборки мусора.

### 2.4. Параметры тестирования

**Решение:**
*   **Алгоритмы (`algos`):** `["SHA-256", "SHA-384", "SHA-512"]`.
*   **Размеры данных (`sizes`):** `[1 КБ, 5 КБ, 10 КБ, 20 КБ, 40 КБ, 80 КБ, 100 КБ]`.

### 2.5. Минимизация систематических ошибок измерений

#### 2.5.1. Прогрев JIT-компилятора

**Решение:** Перед началом любого измерения для каждой тестовой ячейки выполняется фаза адаптивного прогрева. Отдельный краткий прогрев также выполняется на этапе начальной калибровки.

#### 2.5.2. Предотвращение мемоизации: производительный пул входных данных

**Решение:** Используется пул из восьми буферов (`poolSize: 8`), которые циклически сменяются. Для избежания джиттера при создании пула, буферы заполняются с помощью быстрого, некриптографического генератора псевдослучайных чисел (PRNG), который однократно инициализируется из безопасного источника (`crypto.getRandomValues`).

### 2.6. Адаптация к среде выполнения (Мобильные vs. Десктоп)

**Решение:** Бенчмарк теперь определяет мобильные окружения и применяет для них отдельный, более консервативный профиль конфигурации.

**Обоснование:** Мобильные устройства с пассивным охлаждением перегреваются и замедляются во время длительных тестов, что искажает результаты. Мобильный профиль использует сокращенный бюджет времени, увеличенное целевое время для батчей (для поглощения шума ОС) и немного ослабленный порог стабильности.

### 2.7. Механизмы обеспечения целостности данных

#### 2.7.1. Обработка состояния видимости вкладки

**Решение:** Бенчмарк отслеживает событие `visibilitychange`. Если страница переходит в фоновый режим, выполнение теста немедленно прерывается, чтобы предотвратить сбор невалидных данных из замедленной вкладки.

#### 2.7.2. Периоды охлаждения (Cooldowns)

**Решение:** При работе с мобильным профилем между измерениями каждой тестовой ячейки вставляется пауза в 1.5 секунды. Это дает процессору устройства возможность остыть, предотвращая накопление тепла и снижая риск троттлинга.

### 2.8. Обеспечение статистической стабильности и точности

#### 2.8.1. Робастная многопроходная калибровка

**Решение:** Начальная оценка производительности ячейки теперь основана на **медиане** трех коротких калибровочных прогонов.

**Обоснование:** Предыдущая однопроходная калибровка была единой точкой отказа. Случайное системное событие могло исказить весь тест. Новый медианный подход эффективно отбрасывает такие выбросы, что ведет к более стабильным и надежным измерениям.

#### 2.8.2. Многофазная организация измерений

Worker выполняет трехфазный процесс:
1.  **Фаза 1: Калибровка:** Быстрый прогон каждой ячейки для оценки производительности.
2.  **Фаза 2: Распределение бюджета:** Общий временной бюджет интеллектуально распределяется между ячейками.
3.  **Фаза 3: Измерение и коррекция:** Основной цикл измерений. Если ячейка нестабильна, она автоматически перезапускается до `MAX_REMEDIATION_ATTEMPTS` раз.

### 2.9. Собираемые метрики (для каждой тестовой ячейки)

Для каждой пары {алгоритм, размер} собирается подробный объект. **Основной метрикой является `momMs`**.
*   **`momMs` (Медиана средних):** Наш основной робастный показатель центральной тенденции.
*   **`bootstrapCi95Ms` (Bootstrap доверительный интервал):** Непараметрический 95% доверительный интервал, теперь вычисляемый эффективно с помощью производительного, безопасно инициализированного PRNG.
*   **`opsPerSec`:** Операций в секунду, рассчитывается как `1000 / momMs`.
*   **`medianMs`, `iqrMs`:** Медиана и межквартильный размах.
*   **`coefficientOfVariation`:** Индикатор качества (`стандартное отклонение / среднее`).
*   `isStable`, `remediationAttempts`: Флаги, указывающие на итоговое состояние качества.
*   `debugSeedFingerprint`: Опциональный, безопасный для приватности хеш от начального значения PRNG, включаемый только в отладочные сборки.

---

## 3. Структура данных и протокол сбора

### 3.1. Структура полезной нагрузки и приватность

**Решение:** Данные отправляются в виде единого JSON-объекта. Полезная нагрузка теперь по умолчанию **защищена с точки зрения приватности**. Отладочная информация с высокой энтропией (например, необработанные тайминги батчей или хеш PRNG) удаляется и включается только при наличии явного флага `debugMode` для внутреннего тестирования.

### 3.2. Архитектура сборщика данных

**Решение:** Устаревший сборщик на базе Google Apps Script был выведен из эксплуатации. Новая архитектура использует безопасный «Backend for Frontend» (BFF) на платформе Cloudflare (Worker + база данных D1), что полностью соответствует Конституции Безопасности проекта.

---

## 4. Стратегия последующего анализа данных

### 4.1. Предварительная обработка и фильтрация данных

1.  **Фильтрация по версии и качеству:** Анализ будет фильтроваться по `scriptVersion` и флагу `isStable`.
2.  **Сегментация по среде:** Новый флаг `isMobile` будет ключевой переменной для сегментации результатов.

### 4.2. Описательная и инференциальная статистика

*   **Основные показатели:** **Медиана средних (`momMs`)** и **Bootstrap доверительный интервал (`bootstrapCi95Ms`)** остаются основными метриками.
*   **Проверка гипотез:** **Линейная смешанная модель (Linear Mixed-Effects Model)** будет использоваться для проверки гипотез, с `log(opsPersec)` в качестве зависимой переменной. `isMobile` будет включен как ключевой фиксированный эффект.
*   **Автоматическое регрессионное тестирование:** Новый CI-процесс (`perf-smoke.yml`) автоматически запускает дымовой тест производительности для каждого pull request, предотвращая регрессии в производительности или стабильности.
